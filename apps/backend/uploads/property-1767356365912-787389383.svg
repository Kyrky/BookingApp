<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 2000" style="background: #f8f9fa;">
  <defs>
    <style>
      .box { fill: #ffffff; stroke: #333; stroke-width: 2; }
      .header { fill: #1e3c72; stroke: #1e3c72; stroke-width: 2; }
      .layer1 { fill: #e7f3ff; stroke: #0066cc; stroke-width: 2; }
      .layer2 { fill: #fff3cd; stroke: #ffc107; stroke-width: 2; }
      .layer3 { fill: #d4edda; stroke: #28a745; stroke-width: 2; }
      .layer4 { fill: #f8d7da; stroke: #dc3545; stroke-width: 2; }
      .layer5 { fill: #e2d5f1; stroke: #6f42c1; stroke-width: 2; }
      .database { fill: #343a40; stroke: #343a40; stroke-width: 2; }
      .cache { fill: #dc3545; stroke: #dc3545; stroke-width: 2; }
      .queue { fill: #fd7e14; stroke: #fd7e14; stroke-width: 2; }
      .external { fill: #20c997; stroke: #20c997; stroke-width: 2; }
      .text { font-family: 'Segoe UI', Arial, sans-serif; font-size: 14px; fill: #333; }
      .text-white { font-family: 'Segoe UI', Arial, sans-serif; font-size: 14px; fill: white; font-weight: 600; }
      .text-small { font-family: 'Segoe UI', Arial, sans-serif; font-size: 11px; fill: #333; }
      .text-tiny { font-family: 'Segoe UI', Arial, sans-serif; font-size: 10px; fill: #555; }
      .text-title { font-family: 'Segoe UI', Arial, sans-serif; font-size: 16px; fill: #1e3c72; font-weight: 600; }
      .arrow { stroke: #666; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .arrow-red { stroke: #dc3545; stroke-width: 2; fill: none; marker-end: url(#arrowhead-red); }
      .arrow-green { stroke: #28a745; stroke-width: 2; fill: none; marker-end: url(#arrowhead-green); }
      .arrow-blue { stroke: #0066cc; stroke-width: 2; fill: none; marker-end: url(#arrowhead-blue); }
      .dashed { stroke-dasharray: 5,5; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#666" />
    </marker>
    <marker id="arrowhead-red" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#dc3545" />
    </marker>
    <marker id="arrowhead-green" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#28a745" />
    </marker>
    <marker id="arrowhead-blue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#0066cc" />
    </marker>
  </defs>

  <!-- Title -->
  <rect x="50" y="20" width="1300" height="70" class="header" rx="8"/>
  <text x="700" y="50" text-anchor="middle" class="text-white" style="font-size: 24px; font-weight: bold;">StreamPulse IAM - –ü–æ–ª–Ω–∞—è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞</text>
  <text x="700" y="75" text-anchor="middle" class="text-white" style="font-size: 12px;">Identity &amp; Access Management Microservice with OAuth 2.0 / OIDC Support</text>

  <!-- External Clients -->
  <text x="100" y="130" class="text-title">üåê –í–Ω–µ—à–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—ã:</text>
  
  <rect x="80" y="145" width="180" height="90" class="external" rx="6"/>
  <text x="170" y="170" text-anchor="middle" class="text-white" style="font-weight: 600;">Web Client</text>
  <text x="170" y="190" text-anchor="middle" class="text-white" style="font-size: 11px;">React/Vue/Angular</text>
  <text x="170" y="205" text-anchor="middle" class="text-white" style="font-size: 11px;">SPA Application</text>
  <text x="170" y="220" text-anchor="middle" class="text-white" style="font-size: 10px;">Authorization Code + PKCE</text>

  <rect x="280" y="145" width="180" height="90" class="external" rx="6"/>
  <text x="370" y="170" text-anchor="middle" class="text-white" style="font-weight: 600;">Mobile App</text>
  <text x="370" y="190" text-anchor="middle" class="text-white" style="font-size: 11px;">iOS / Android</text>
  <text x="370" y="205" text-anchor="middle" class="text-white" style="font-size: 11px;">Native Application</text>
  <text x="370" y="220" text-anchor="middle" class="text-white" style="font-size: 10px;">OAuth 2.0 Client</text>

  <rect x="480" y="145" width="180" height="90" class="external" rx="6"/>
  <text x="570" y="170" text-anchor="middle" class="text-white" style="font-weight: 600;">3rd Party Services</text>
  <text x="570" y="190" text-anchor="middle" class="text-white" style="font-size: 11px;">External APIs</text>
  <text x="570" y="205" text-anchor="middle" class="text-white" style="font-size: 11px;">Microservices</text>
  <text x="570" y="220" text-anchor="middle" class="text-white" style="font-size: 10px;">Client Credentials</text>

  <rect x="1070" y="145" width="260" height="90" class="external" rx="6"/>
  <text x="1200" y="170" text-anchor="middle" class="text-white" style="font-weight: 600;">External Auth Providers</text>
  <text x="1110" y="195" text-anchor="start" class="text-white" style="font-size: 11px;">‚Ä¢ Google OAuth</text>
  <text x="1110" y="210" text-anchor="start" class="text-white" style="font-size: 11px;">‚Ä¢ GitHub OAuth</text>
  <text x="1110" y="225" text-anchor="start" class="text-white" style="font-size: 11px;">‚Ä¢ Microsoft Azure AD</text>

  <!-- Load Balancer / API Gateway -->
  <rect x="380" y="270" width="440" height="100" class="box" rx="8" style="fill: #17a2b8; stroke: #17a2b8;"/>
  <text x="600" y="300" text-anchor="middle" class="text-white" style="font-size: 18px; font-weight: 600;">üö™ API Gateway / Load Balancer</text>
  <text x="400" y="325" text-anchor="start" class="text-white" style="font-size: 12px;">‚Ä¢ Rate Limiting (100 req/min)</text>
  <text x="400" y="343" text-anchor="start" class="text-white" style="font-size: 12px;">‚Ä¢ SSL/TLS Termination</text>
  <text x="400" y="361" text-anchor="start" class="text-white" style="font-size: 12px;">‚Ä¢ Request Routing</text>
  <text x="630" y="325" text-anchor="start" class="text-white" style="font-size: 12px;">‚Ä¢ DDoS Protection</text>
  <text x="630" y="343" text-anchor="start" class="text-white" style="font-size: 12px;">‚Ä¢ IP Whitelisting</text>
  <text x="630" y="361" text-anchor="start" class="text-white" style="font-size: 12px;">‚Ä¢ Circuit Breaker</text>

  <!-- Arrows from clients to gateway -->
  <path d="M 170 235 L 500 270" class="arrow-blue"/>
  <path d="M 370 235 L 550 270" class="arrow-blue"/>
  <path d="M 570 235 L 600 270" class="arrow-blue"/>
  
  <!-- Arrow to external auth -->
  <path d="M 820 320 L 1070 200" class="arrow-green dashed"/>
  <text x="900" y="250" class="text-tiny" fill="#28a745">Social Login</text>

  <!-- IAM Microservice Container -->
  <rect x="60" y="410" width="1280" height="1070" class="header" rx="8"/>
  <text x="700" y="445" text-anchor="middle" class="text-white" style="font-size: 20px; font-weight: bold;">StreamPulse IAM Microservice</text>

  <!-- Arrow from gateway to IAM -->
  <path d="M 600 370 L 600 410" class="arrow"/>

  <!-- Middleware Layer -->
  <rect x="80" y="470" width="1240" height="110" class="layer5" rx="6"/>
  <text x="100" y="495" class="text-title">üõ°Ô∏è Middleware &amp; Cross-Cutting Concerns</text>
  
  <rect x="100" y="510" width="170" height="55" class="box" rx="4"/>
  <text x="185" y="530" text-anchor="middle" class="text" style="font-weight: 600;">Authentication</text>
  <text x="110" y="548" class="text-small">‚Ä¢ JWT Validation</text>
  <text x="110" y="560" class="text-small">‚Ä¢ Token Refresh</text>

  <rect x="290" y="510" width="170" height="55" class="box" rx="4"/>
  <text x="375" y="530" text-anchor="middle" class="text" style="font-weight: 600;">Authorization</text>
  <text x="300" y="548" class="text-small">‚Ä¢ RBAC Checks</text>
  <text x="300" y="560" class="text-small">‚Ä¢ Permission Verify</text>

  <rect x="480" y="510" width="170" height="55" class="box" rx="4"/>
  <text x="565" y="530" text-anchor="middle" class="text" style="font-weight: 600;">Validation</text>
  <text x="490" y="548" class="text-small">‚Ä¢ FluentValidation</text>
  <text x="490" y="560" class="text-small">‚Ä¢ Model Binding</text>

  <rect x="670" y="510" width="170" height="55" class="box" rx="4"/>
  <text x="755" y="530" text-anchor="middle" class="text" style="font-weight: 600;">Exception Handler</text>
  <text x="680" y="548" class="text-small">‚Ä¢ Global Errors</text>
  <text x="680" y="560" class="text-small">‚Ä¢ Error Responses</text>

  <rect x="860" y="510" width="170" height="55" class="box" rx="4"/>
  <text x="945" y="530" text-anchor="middle" class="text" style="font-weight: 600;">CORS Policy</text>
  <text x="870" y="548" class="text-small">‚Ä¢ Origin Control</text>
  <text x="870" y="560" class="text-small">‚Ä¢ Headers Config</text>

  <rect x="1050" y="510" width="250" height="55" class="box" rx="4"/>
  <text x="1175" y="530" text-anchor="middle" class="text" style="font-weight: 600;">Request/Response Logging</text>
  <text x="1060" y="548" class="text-small">‚Ä¢ Structured Logs (Serilog)</text>
  <text x="1060" y="560" class="text-small">‚Ä¢ Correlation IDs</text>

  <!-- Presentation Layer -->
  <rect x="80" y="600" width="1240" height="160" class="layer1" rx="6"/>
  <text x="100" y="625" class="text-title">üìã Presentation Layer (REST API Controllers)</text>
  
  <rect x="100" y="645" width="180" height="95" class="box" rx="4"/>
  <text x="190" y="665" text-anchor="middle" class="text" style="font-weight: 600;">AuthController</text>
  <text x="110" y="683" class="text-small">‚Ä¢ POST /auth/login</text>
  <text x="110" y="696" class="text-small">‚Ä¢ POST /auth/register</text>
  <text x="110" y="709" class="text-small">‚Ä¢ POST /auth/refresh</text>
  <text x="110" y="722" class="text-small">‚Ä¢ POST /auth/logout</text>
  <text x="110" y="735" class="text-small">‚Ä¢ GET /auth/confirm-email</text>

  <rect x="300" y="645" width="180" height="95" class="box" rx="4"/>
  <text x="390" y="665" text-anchor="middle" class="text" style="font-weight: 600;">UserController</text>
  <text x="310" y="683" class="text-small">‚Ä¢ GET /users</text>
  <text x="310" y="696" class="text-small">‚Ä¢ GET /users/{id}</text>
  <text x="310" y="709" class="text-small">‚Ä¢ PUT /users/{id}</text>
  <text x="310" y="722" class="text-small">‚Ä¢ DELETE /users/{id}</text>
  <text x="310" y="735" class="text-small">‚Ä¢ POST /users/{id}/roles</text>

  <rect x="500" y="645" width="180" height="95" class="box" rx="4"/>
  <text x="590" y="665" text-anchor="middle" class="text" style="font-weight: 600;">RoleController</text>
  <text x="510" y="683" class="text-small">‚Ä¢ GET /roles</text>
  <text x="510" y="696" class="text-small">‚Ä¢ POST /roles</text>
  <text x="510" y="709" class="text-small">‚Ä¢ PUT /roles/{id}</text>
  <text x="510" y="722" class="text-small">‚Ä¢ DELETE /roles/{id}</text>
  <text x="510" y="735" class="text-small">‚Ä¢ GET /roles/{id}/perms</text>

  <rect x="700" y="645" width="190" height="95" class="box" rx="4"/>
  <text x="795" y="665" text-anchor="middle" class="text" style="font-weight: 600;">OAuthController</text>
  <text x="710" y="683" class="text-small">‚Ä¢ GET /oauth/authorize</text>
  <text x="710" y="696" class="text-small">‚Ä¢ POST /oauth/token</text>
  <text x="710" y="709" class="text-small">‚Ä¢ POST /oauth/revoke</text>
  <text x="710" y="722" class="text-small">‚Ä¢ GET /oauth/introspect</text>
  <text x="710" y="735" class="text-small">‚Ä¢ GET /.well-known/jwks</text>

  <rect x="910" y="645" width="190" height="95" class="box" rx="4"/>
  <text x="1005" y="665" text-anchor="middle" class="text" style="font-weight: 600;">PermissionController</text>
  <text x="920" y="683" class="text-small">‚Ä¢ GET /permissions</text>
  <text x="920" y="696" class="text-small">‚Ä¢ POST /permissions</text>
  <text x="920" y="709" class="text-small">‚Ä¢ DELETE /perms/{id}</text>
  <text x="920" y="722" class="text-small">‚Ä¢ POST /perms/check</text>
  <text x="920" y="735" class="text-small">‚Ä¢ GET /users/{id}/perms</text>

  <rect x="1120" y="645" width="180" height="95" class="box" rx="4"/>
  <text x="1210" y="665" text-anchor="middle" class="text" style="font-weight: 600;">SessionController</text>
  <text x="1130" y="683" class="text-small">‚Ä¢ GET /sessions</text>
  <text x="1130" y="696" class="text-small">‚Ä¢ GET /sessions/active</text>
  <text x="1130" y="709" class="text-small">‚Ä¢ DELETE /sessions/{id}</text>
  <text x="1130" y="722" class="text-small">‚Ä¢ DELETE /sessions/all</text>
  <text x="1130" y="735" class="text-small">‚Ä¢ GET /sessions/history</text>

  <!-- Arrow to Application Layer -->
  <path d="M 700 760 L 700 790" class="arrow"/>

  <!-- Application Layer (CQRS) -->
  <rect x="80" y="790" width="1240" height="220" class="layer2" rx="6"/>
  <text x="100" y="815" class="text-title">‚öôÔ∏è Application Layer (CQRS + MediatR + Domain Events)</text>
  
  <rect x="100" y="835" width="380" height="155" class="box" rx="4"/>
  <text x="290" y="855" text-anchor="middle" class="text" style="font-weight: 600;">Commands (Write Operations)</text>
  <text x="110" y="875" class="text-small" style="font-weight: 600;">Auth Commands:</text>
  <text x="120" y="890" class="text-small">‚Ä¢ LoginCommand ‚Üí LoginHandler</text>
  <text x="120" y="903" class="text-small">‚Ä¢ RegisterCommand ‚Üí RegisterHandler</text>
  <text x="120" y="916" class="text-small">‚Ä¢ RefreshTokenCommand ‚Üí RefreshHandler</text>
  <text x="120" y="929" class="text-small">‚Ä¢ LogoutCommand ‚Üí LogoutHandler</text>
  <text x="110" y="947" class="text-small" style="font-weight: 600;">User/Role Commands:</text>
  <text x="120" y="962" class="text-small">‚Ä¢ AssignRoleCommand</text>
  <text x="120" y="975" class="text-small">‚Ä¢ CreateRoleCommand</text>
  <text x="280" y="890" class="text-small">‚Ä¢ RevokeTokenCommand</text>
  <text x="280" y="903" class="text-small">‚Ä¢ UpdateUserCommand</text>
  <text x="280" y="916" class="text-small">‚Ä¢ DeleteUserCommand</text>
  <text x="280" y="929" class="text-small">‚Ä¢ GrantPermissionCommand</text>

  <rect x="500" y="835" width="380" height="155" class="box" rx="4"/>
  <text x="690" y="855" text-anchor="middle" class="text" style="font-weight: 600;">Queries (Read Operations)</text>
  <text x="510" y="875" class="text-small" style="font-weight: 600;">User Queries:</text>
  <text x="520" y="890" class="text-small">‚Ä¢ GetUserByIdQuery</text>
  <text x="520" y="903" class="text-small">‚Ä¢ GetAllUsersQuery</text>
  <text x="520" y="916" class="text-small">‚Ä¢ GetUserPermissionsQuery</text>
  <text x="520" y="929" class="text-small">‚Ä¢ SearchUsersQuery</text>
  <text x="510" y="947" class="text-small" style="font-weight: 600;">Auth Queries:</text>
  <text x="520" y="962" class="text-small">‚Ä¢ ValidateTokenQuery</text>
  <text x="520" y="975" class="text-small">‚Ä¢ GetUserSessionsQuery</text>
  <text x="700" y="890" class="text-small">‚Ä¢ GetRolesQuery</text>
  <text x="700" y="903" class="text-small">‚Ä¢ GetPermissionsQuery</text>
  <text x="700" y="916" class="text-small">‚Ä¢ CheckPermissionQuery</text>
  <text x="700" y="929" class="text-small">‚Ä¢ GetOAuthClientQuery</text>

  <rect x="900" y="835" width="400" height="155" class="box" rx="4"/>
  <text x="1100" y="855" text-anchor="middle" class="text" style="font-weight: 600;">Domain Events &amp; Event Handlers</text>
  <text x="910" y="875" class="text-small" style="font-weight: 600;">Events:</text>
  <text x="920" y="890" class="text-small">‚Ä¢ UserRegisteredEvent</text>
  <text x="920" y="903" class="text-small">‚Ä¢ UserLoggedInEvent</text>
  <text x="920" y="916" class="text-small">‚Ä¢ RoleAssignedEvent</text>
  <text x="920" y="929" class="text-small">‚Ä¢ PermissionGrantedEvent</text>
  <text x="920" y="942" class="text-small">‚Ä¢ TokenRevokedEvent</text>
  <text x="1120" y="890" class="text-small">‚Ä¢ UserDeletedEvent</text>
  <text x="1120" y="903" class="text-small">‚Ä¢ PasswordChangedEvent</text>
  <text x="1120" y="916" class="text-small">‚Ä¢ SessionExpiredEvent</text>
  <text x="910" y="960" class="text-small" style="font-weight: 600;">Handlers:</text>
  <text x="920" y="975" class="text-small">‚Üí SendEmailHandler, AuditLogHandler, CacheInvalidationHandler</text>

  <!-- Arrow to Domain Layer -->
  <path d="M 700 1010 L 700 1040" class="arrow"/>

  <!-- Domain Layer -->
  <rect x="80" y="1040" width="1240" height="170" class="layer3" rx="6"/>
  <text x="100" y="1065" class="text-title">üß© Domain Layer (Rich Domain Model &amp; Business Rules)</text>
  
  <rect x="100" y="1085" width="1200" height="105" class="box" rx="4"/>
  <text x="110" y="1105" class="text-small" style="font-weight: 600;">Domain Entities (Aggregates):</text>
  <text x="110" y="1122" class="text-small">‚Ä¢ <text style="font-weight: 600;">User</text> - –º–µ—Ç–æ–¥—ã: GetPermissions(), HasPermission(resource, action), AssignRole(), RemoveRole()</text>
  <text x="110" y="1137" class="text-small">‚Ä¢ <text style="font-weight: 600;">Role</text> - –∫–æ–ª–ª–µ–∫—Ü–∏—è Permissions, –º–µ—Ç–æ–¥—ã: AddPermission(), RemovePermission(), GetPermissionList()</text>
  <text x="110" y="1152" class="text-small">‚Ä¢ <text style="font-weight: 600;">Permission</text> - Value Object (resource:action), –º–µ—Ç–æ–¥—ã: IsValidFormat(), Matches(pattern)</text>
  <text x="110" y="1167" class="text-small">‚Ä¢ <text style="font-weight: 600;">OAuthClient</text> - ClientId, ClientSecret, RedirectUris, Scopes, GrantTypes</text>
  <text x="110" y="1182" class="text-small">‚Ä¢ <text style="font-weight: 600;">RefreshToken</text> - Token, ExpiresAt, IsRevoked, RevokedAt, –º–µ—Ç–æ–¥—ã: Revoke(), IsExpired()</text>
  
  <text x="700" y="1122" class="text-small">‚Ä¢ <text style="font-weight: 600;">AuthorizationCode</text> - Code, PKCE Challenge, ExpiresAt, IsUsed</text>
  <text x="700" y="1137" class="text-small">‚Ä¢ <text style="font-weight: 600;">UserSession</text> - SessionId, LastActivity, IP, UserAgent, IsActive()</text>
  <text x="700" y="1152" class="text-small">‚Ä¢ <text style="font-weight: 600;">AuditLog</text> - Action, EntityType, Changes, Timestamp, UserId</text>
  
  <text x="110" y="1200" class="text-small" style="font-weight: 600;">Domain Services:</text>
  <text x="120" y="1215" class="text-small">PermissionEvaluator, RoleHierarchyService, PasswordPolicy, TokenExpirationPolicy</text>

  <!-- Arrow to Infrastructure Layer -->
  <path d="M 700 1210 L 700 1240" class="arrow"/>

  <!-- Infrastructure Layer -->
  <rect x="80" y="1240" width="1240" height="220" class="layer4" rx="6"/>
  <text x="100" y="1265" class="text-title">üîß Infrastructure Layer (Technical Implementation)</text>
  
  <rect x="100" y="1285" width="210" height="155" class="box" rx="4"/>
  <text x="205" y="1305" text-anchor="middle" class="text" style="font-weight: 600;">Data Access</text>
  <text x="110" y="1323" class="text-small">‚Ä¢ EF Core DbContext</text>
  <text x="110" y="1338" class="text-small">‚Ä¢ MySQL Provider</text>
  <text x="110" y="1353" class="text-small">‚Ä¢ Generic Repository&lt;T&gt;</text>
  <text x="110" y="1368" class="text-small">‚Ä¢ Unit of Work Pattern</text>
  <text x="110" y="1383" class="text-small">‚Ä¢ Database Migrations</text>
  <text x="110" y="1398" class="text-small">‚Ä¢ Query Optimization</text>
  <text x="110" y="1413" class="text-small">‚Ä¢ Connection Pooling</text>
  <text x="110" y="1428" class="text-small">‚Ä¢ Transaction Management</text>

  <rect x="330" y="1285" width="210" height="155" class="box" rx="4"/>
  <text x="435" y="1305" text-anchor="middle" class="text" style="font-weight: 600;">Security Services</text>
  <text x="340" y="1323" class="text-small">‚Ä¢ JwtProvider (RS256)</text>
  <text x="340" y="1338" class="text-small">‚Ä¢ PasswordHasher (BCrypt)</text>
  <text x="340" y="1353" class="text-small">‚Ä¢ TokenGenerator</text>
  <text x="340" y="1368" class="text-small">‚Ä¢ PKCE Validator</text>
  <text x="340" y="1383" class="text-small">‚Ä¢ RSA Key Manager</text>
  <text x="340" y="1398" class="text-small">‚Ä¢ OAuth2 Flow Handler</text>
  <text x="340" y="1413" class="text-small">‚Ä¢ CSRF Token Provider</text>
  <text x="340" y="1428" class="text-small">‚Ä¢ Rate Limiter</text>

  <rect x="560" y="1285" width="210" height="155" class="box" rx="4"/>
  <text x="665" y="1305" text-anchor="middle" class="text" style="font-weight: 600;">External Services</text>
  <text x="570" y="1323" class="text-small">‚Ä¢ EmailService (MailKit)</text>
  <text x="570" y="1338" class="text-small">‚Ä¢ SMTP Configuration</text>
  <text x="570" y="1353" class="text-small">‚Ä¢ Template Engine</text>
  <text x="570" y="1368" class="text-small">‚Ä¢ SMS Service (Twilio)</text>
  <text x="570" y="1383" class="text-small">‚Ä¢ Push Notifications</text>
  <text x="570" y="1398" class="text-small">‚Ä¢ File Storage (S3)</text>
  <text x="570" y="1413" class="text-small">‚Ä¢ OAuth Provider API</text>
  <text x="570" y="1428" class="text-small">‚Ä¢ Webhook Dispatcher</text>

  <rect x="790" y="1285" width="210" height="155" class="box" rx="4"/>
  <text x="895" y="1305" text-anchor="middle" class="text" style="font-weight: 600;">Monitoring &amp; Logging</text>
  <text x="800" y="1323" class="text-small">‚Ä¢ Serilog (Structured)</text>
  <text x="800" y="1338" class="text-small">‚Ä¢ Seq / ELK Integration</text>
  <text x="800" y="1353" class="text-small">‚Ä¢ Request Tracking</text>
  <text x="800" y="1368" class="text-small">‚Ä¢ Performance Metrics</text>
  <text x="800" y="1383" class="text-small">‚Ä¢ Health Checks</text>
  <text x="800" y="1398" class="text-small">‚Ä¢ Audit Log Writer</text>
  <text x="800" y="1413" class="text-small">‚Ä¢ Error Tracking</text>
  <text x="800" y="1428" class="text-small">‚Ä¢ Distributed Tracing</text>

  <rect x="1020" y="1285" width="280" height="155" class="box" rx="4"/>
  <text x="1160" y="1305" text-anchor="middle" class="text" style="font-weight: 600;">Background Jobs &amp; Queues</text>
  <text x="1030" y="1323" class="text-small">‚Ä¢ Hangfire / Quartz.NET</text>
  <text x="1030" y="1338" class="text-small">‚Ä¢ Token Cleanup Job (1h)</text>
  <text x="1030" y="1353" class="text-small">‚Ä¢ Session Expiration (15m)</text>
  <text x="1030" y="1368" class="text-small">‚Ä¢ Email Queue Processor</text>
  <text x="1030" y="1383" class="text-small">‚Ä¢ Audit Log Aggregation</text>
  <text x="1030" y="1398" class="text-small">‚Ä¢ Failed Login Tracker</text>
  <text x="1030" y="1413" class="text-small">‚Ä¢ Metrics Collector</text>
  <text x="1030" y="1428" class="text-small">‚Ä¢ Cache Warming Task</text>
  
  <!-- Arrow from Background Jobs to Message Queue -->
  <path d="M 1160 1440 L 660 1480" class="arrow-green dashed"/>
  <text x="880" y="1468" class="text-tiny" fill="#28a745">Job consumers</text>

  <!-- Arrow from Infrastructure to Cache/Queue -->
  <path d="M 700 1460 L 380 1480" class="arrow-red dashed"/>
  <path d="M 700 1460 L 780 1480" class="arrow-green"/>
  <text x="480" y="1475" class="text-tiny" fill="#dc3545">Cache layer</text>
  <text x="700" y="1475" class="text-tiny" fill="#28a745">Event pub/sub</text>

  <!-- Side components: Cache and Message Queue (moved below Infrastructure) -->
  <rect x="100" y="1480" width="250" height="130" class="cache" rx="6"/>
  <text x="225" y="1505" text-anchor="middle" class="text-white" style="font-weight: 600;">üî¥ Redis Cache Layer</text>
  <text x="110" y="1525" class="text-white" style="font-size: 11px;">‚Ä¢ Session Storage (in-memory)</text>
  <text x="110" y="1540" class="text-white" style="font-size: 11px;">‚Ä¢ Token Blacklist (revoked tokens)</text>
  <text x="110" y="1555" class="text-white" style="font-size: 11px;">‚Ä¢ User Permissions Cache</text>
  <text x="110" y="1570" class="text-white" style="font-size: 11px;">‚Ä¢ Rate Limit Counters</text>
  <text x="110" y="1585" class="text-white" style="font-size: 11px;">‚Ä¢ OAuth State Storage</text>
  <text x="110" y="1600" class="text-white" style="font-size: 10px; font-style: italic;">TTL: 15min - 24h</text>

  <rect x="380" y="1480" width="280" height="130" class="queue" rx="6"/>
  <text x="520" y="1505" text-anchor="middle" class="text-white" style="font-weight: 600;">üü† Message Queue (RabbitMQ/Kafka)</text>
  <text x="390" y="1525" text-anchor="start" class="text-white" style="font-size: 11px;">‚Ä¢ Email Notification Events</text>
  <text x="390" y="1540" text-anchor="start" class="text-white" style="font-size: 11px;">‚Ä¢ Audit Log Events</text>
  <text x="390" y="1555" text-anchor="start" class="text-white" style="font-size: 11px;">‚Ä¢ Domain Events (UserRegistered, etc.)</text>
  <text x="390" y="1570" text-anchor="start" class="text-white" style="font-size: 11px;">‚Ä¢ Integration Events (cross-service)</text>
  <text x="390" y="1585" text-anchor="start" class="text-white" style="font-size: 11px;">‚Ä¢ Webhook Delivery Queue</text>
  <text x="390" y="1600" text-anchor="start" class="text-white" style="font-size: 10px; font-style: italic;">Async processing with retry logic</text>
  
  <!-- Arrows from Cache/Queue to Database -->
  <path d="M 225 1610 L 380 1680" class="arrow-red dashed"/>
  <path d="M 520 1610 L 600 1680" class="arrow"/>
  <text x="280" y="1650" class="text-tiny" fill="#dc3545">Cache writes to DB</text>
  <text x="530" y="1650" class="text-tiny" fill="#666">Persistence</text>

  <!-- Arrow from Infrastructure to Database -->
  <path d="M 700 1610 L 700 1680" class="arrow"/>

  <!-- Database -->
  <rect x="250" y="1680" width="900" height="230" class="database" rx="8"/>
  <text x="700" y="1710" text-anchor="middle" class="text-white" style="font-size: 18px; font-weight: 600;">üóÑÔ∏è MySQL Database (Master-Slave Replication)</text>
  
  <text x="270" y="1740" class="text-white" style="font-size: 13px; font-weight: 600;">Core Tables:</text>
  <text x="270" y="1760" class="text-white" style="font-size: 11px;">‚Ä¢ Users (Id, Email, PasswordHash, EmailConfirmed, CreatedAt)</text>
  <text x="270" y="1775" class="text-white" style="font-size: 11px;">‚Ä¢ Roles (Id, Name, Description, IsSystemRole)</text>
  <text x="270" y="1790" class="text-white" style="font-size: 11px;">‚Ä¢ Permissions (Id, Resource, Action, Description)</text>
  <text x="270" y="1805" class="text-white" style="font-size: 11px;">‚Ä¢ UserRoles (UserId, RoleId) - Many-to-Many</text>
  <text x="270" y="1820" class="text-white" style="font-size: 11px;">‚Ä¢ RolePermissions (RoleId, PermissionId) - Many-to-Many</text>
  
  <text x="270" y="1845" class="text-white" style="font-size: 13px; font-weight: 600;">Auth Tables:</text>
  <text x="270" y="1865" class="text-white" style="font-size: 11px;">‚Ä¢ RefreshTokens (Token, UserId, ExpiresAt, IsRevoked, CreatedAt)</text>
  <text x="270" y="1880" class="text-white" style="font-size: 11px;">‚Ä¢ AuthorizationCodes (Code, ClientId, UserId, PkceChallenge, ExpiresAt)</text>
  <text x="270" y="1895" class="text-white" style="font-size: 11px;">‚Ä¢ OAuthClients (ClientId, ClientSecret, RedirectUris, Scopes, GrantTypes)</text>
  
  <text x="750" y="1760" class="text-white" style="font-size: 11px;">‚Ä¢ UserSessions (Id, UserId, SessionToken, LastActivity, IP, UserAgent)</text>
  <text x="750" y="1775" class="text-white" style="font-size: 11px;">‚Ä¢ AuditLogs (Id, UserId, Action, EntityType, Changes, Timestamp)</text>
  <text x="750" y="1790" class="text-white" style="font-size: 11px;">‚Ä¢ EmailConfirmationTokens (Token, UserId, ExpiresAt, IsUsed)</text>
  <text x="750" y="1805" class="text-white" style="font-size: 11px;">‚Ä¢ PasswordResetTokens (Token, UserId, ExpiresAt, IsUsed)</text>
  <text x="750" y="1820" class="text-white" style="font-size: 11px;">‚Ä¢ LoginAttempts (UserId, IP, Success, Timestamp)</text>
  
  <text x="750" y="1845" class="text-white" style="font-size: 13px; font-weight: 600;">Performance:</text>
  <text x="750" y="1865" class="text-white" style="font-size: 11px;">‚úì Indexes on FK, Email, Timestamps</text>
  <text x="750" y="1880" class="text-white" style="font-size: 11px;">‚úì ACID Transactions</text>
  <text x="750" y="1895" class="text-white" style="font-size: 11px;">‚úì Connection Pooling (Max 100)</text>
  
  <!-- Legend -->
  <rect x="80" y="1930" width="1240" height="50" class="box" rx="4" style="fill: #fff; stroke: #333;"/>
  <text x="100" y="1950" class="text" style="font-weight: 600;">–õ–µ–≥–µ–Ω–¥–∞:</text>
  
  <!-- Arrow types -->
  <line x1="180" y1="1945" x2="230" y2="1945" class="arrow"/>
  <text x="240" y="1950" class="text-small">–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤</text>
  
  <line x1="380" y1="1945" x2="430" y2="1945" class="arrow-red dashed"/>
  <text x="440" y="1950" class="text-small">–ö—ç—à read/write</text>
  
  <line x1="580" y1="1945" x2="630" y2="1945" class="arrow-green"/>
  <text x="640" y="1950" class="text-small">–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è</text>
  
  <line x1="820" y1="1945" x2="870" y2="1945" class="arrow-blue"/>
  <text x="880" y="1950" class="text-small">HTTPS Request</text>
  
  <!-- Color meanings -->
  <rect x="180" y="1960" width="15" height="15" class="layer1"/>
  <text x="200" y="1972" class="text-small">Presentation</text>
  
  <rect x="300" y="1960" width="15" height="15" class="layer2"/>
  <text x="320" y="1972" class="text-small">Application</text>
  
  <rect x="410" y="1960" width="15" height="15" class="layer3"/>
  <text x="430" y="1972" class="text-small">Domain</text>
  
  <rect x="510" y="1960" width="15" height="15" class="layer4"/>
  <text x="530" y="1972" class="text-small">Infrastructure</text>
  
  <rect x="650" y="1960" width="15" height="15" class="cache"/>
  <text x="670" y="1972" class="text-small">Cache</text>
  
  <rect x="730" y="1960" width="15" height="15" class="queue"/>
  <text x="750" y="1972" class="text-small">Queue</text>
  
  <rect x="820" y="1960" width="15" height="15" class="database"/>
  <text x="840" y="1972" class="text-small">Database</text>
  
  <rect x="930" y="1960" width="15" height="15" class="external"/>
  <text x="950" y="1972" class="text-small">External</text>
</svg>